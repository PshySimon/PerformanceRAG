# 数据源-生产者-消费者Pipeline配置
# 数据源: loader + splitter
# 生产者: embedding
# 消费者: indexer

datasource:
  components:
    document_loader:
      type: "loader"
      name: "file"
      config:
        path: "/Users/caixiaomeng/Projects/Python/EasyRAG/data/format_data_with_img"
        file_types: [".txt", ".md"]
        encoding: "utf-8"
        debug: true
    
    text_splitter:
      type: "splitter"
      name: "hierarchical"
      config:
        chunk_sizes: [512, 256]
        chunk_overlap: 50
        include_metadata: true
        max_chunk_size: 600
        fallback_config:
          primary:
            type: "text"
            split_method: "character"
            chunk_size: 400
            chunk_overlap: 50
            include_metadata: true
        debug: true
  
  flow:
    document_loader: ["text_splitter"]
    text_splitter: []
  
  entry_point: "document_loader"

producer:
  components:
    openai_embedding:
      type: "embedding"
      name: "openai"
      config:
        model: "models/bge-m3"
        api_key: "123456"
        api_base: "http://workspace.featurize.cn:33336/v1"
        batch_size: 150  # 缓存大小，凑齐100条再请求
        timeout: 60
        max_retries: 3
        debug: true
  
  flow:
    openai_embedding: []
  
  entry_point: "openai_embedding"

consumer:
  components:
    es_vector_indexer:
      type: "indexer"
      name: "elasticsearch"
      config:
        index_name: "vector_performance_docs"
        host: "localhost"
        port: 9200
        username: "elastic"
        password: "sPxLec=NGSFmUT_7+74R"
        use_ssl: true
        verify_certs: false
        batch_size: 100  # 减少batch_size，避免超时
        timeout: 30
        debug: true
        # 优化ES索引设置
        index_settings:
          number_of_shards: 1
          number_of_replicas: 0  # 禁用副本提高写入速度
          refresh_interval: "30s"  # 延长刷新间隔
          translog:
            durability: "async"  # 异步事务日志
        mapping:
          properties:
            content:
              type: "text"
              analyzer: "standard"
            content_vector:
              type: "dense_vector"
              dims: 1024  # 需要改为 BGE-M3 的实际维度
              index: true
              similarity: "cosine"
            metadata:
              type: "object"
            timestamp:
              type: "date"
  
  flow:
    es_vector_indexer: []
  
  entry_point: "es_vector_indexer"
  
  # 消费者配置
  config:
    batch_size: 50        # 增加批次大小
    max_queue_size: 2000  # 减少队列大小
    producer_tasks: 3   # 增加生产者线程
    consumer_tasks: 3   # 减少消费者线程
    timeout: 30
    rate_limit_per_second: 100  # 提高速率限制
    preload_all_data: true  # 新增：启用预加载模式